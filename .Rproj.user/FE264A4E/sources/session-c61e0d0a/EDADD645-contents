# Snabbstart - Gothenburg Maps

I det här dokumentet finns ett antal konkreta scenarier för att komma igång snabbt.

## Förberedelse

```r
# Ladda funktioner och färger
source("R/00_setup.R")
source("path/to/gothenburg_colors/colors.R")

# Ladda exempeldata
befolkning <- readRDS("examples/data/gbg_primaromrade.rds")
```

---

## 1. Enkel tematisk karta

Standard choropleth-karta med 5 klasser.

```r
# Ladda och koppla data
primaromraden <- load_prepared_map("goteborg/primaromraden")
karta <- join_stat_to_map(primaromraden, befolkning, by = "omrade_kod")

# Klassindela
breaks <- create_breaks(karta$oktober, "fisher", 5)
labels <- create_labels(breaks, "range", decimals = 0)
karta$klass <- apply_classification(karta$oktober, breaks, labels)

# Ta fram en karta
ggplot(karta, aes(fill = klass)) +
  geom_sf(color = "white", linewidth = 0.1) +
  scale_fill_gbg_sequential("blue", n = 5) +
  labs(title = "Befolkning i oktober per primärområde", fill = "Invånare") +
  theme_gothenburg_map()

# Spara
ggsave("output/maps/befolkning.png", width = 12, height = 8, dpi = 300)
```

---

## 2. Divergerande karta (förändring)

Visar positiv/negativ förändring.

```r
# Ladda och koppla
primaromraden <- load_prepared_map("goteborg/primaromraden")
karta <- join_stat_to_map(primaromraden, befolkning, by = "omrade_kod")

# Klassindela med quantile (bra för skev data)
breaks <- create_breaks(karta$forandring, "quantile", 5)
labels <- create_labels(breaks, "range", decimals = 0)
karta$klass <- apply_classification(karta$forandring, breaks, labels)

# Röd-grön färgpalett
ggplot(karta, aes(fill = klass)) +
  geom_sf(color = "black", linewidth = 0.1) +
  scale_fill_gbg_diverging("red_green", n = 5) +
  labs(
    title = "Befolkningsförändring 2024",
    fill = "Förändring",
    caption = "Källa: SCB"
  ) +
  theme_gothenburg_map()
```

---

## 3. Karta med extra lager (vatten + gränser)

Lägg till vattenlager och stadsområdesgränser.

```r
# Ladda alla lager
primaromraden <- load_prepared_map("goteborg/primaromraden")
stadsomraden <- load_prepared_map("goteborg/stadsomraden")
alv <- load_water_layer("goteborg/alv_goteborg")

# Koppla data
karta <- join_stat_to_map(primaromraden, befolkning, by = "omrade_kod")

# Klassindela
breaks <- create_breaks(karta$forandring_procent, "fisher", 6)
labels <- create_labels(breaks, "range", unit = "%", decimals = 1)
karta$klass <- apply_classification(karta$forandring_procent, breaks, labels)

# Skapa karta med flera lager
ggplot() +
  geom_sf(data = karta, aes(fill = klass), color = "white", linewidth = 0.1) +
  geom_sf(data = alv, fill = "#b3d9ff", color = NA) +
  geom_sf(data = stadsomraden, fill = NA, color = "black", linewidth = 0.3) +
  scale_fill_gbg_sequential("blue", n = 6) +
  labs(title = "Procentuell befolkningsförändring", fill = "Förändring (%)") +
  theme_gothenburg_map()
```

---

## 4. Snabbkarta med create_static_map()

Allt-i-ett funktion för snabbanalys.

```r
karta <- create_static_map(
  stat_data = befolkning,
  geo_layer = "goteborg/primaromraden",
  value_col = "forandring",
  by = "omrade_kod",
  classify_method = "fisher",
  n_classes = 6,
  palette_type = "diverging",
  palette_name = "red_green",
  title = "Befolkningsförändring",
  legend_title = "Förändring",
  caption = "Källa: SCB"
)

print(karta)
```

---

## 5. Interaktiv webbkarta

Karta med tooltips för webb eller Quarto-rapport.

```r
karta_webb <- create_interactive_map(
  stat_data = befolkning,
  geo_layer = "goteborg/primaromraden",
  value_col = "oktober",
  by = "omrade_kod",
  classify_method = "fisher",
  n_classes = 5,
  palette_type = "sequential",
  palette_name = "blue",
  label_decimals = 0,
  title = "Befolkning per område",
  tooltip_cols = c("omrade_namn", "oktober", "forandring"),
  tooltip_alias = c("Område", "Befolkning", "Befolkningsförändring")
)

# Visa i RStudio
print(karta_webb)

# Spara som HTML
htmlwidgets::saveWidget(karta_webb, "output/maps/befolkning.html")
```

---

## 6. Anpassa tema och färger

Kontrollera legend och färger.

```r
# Ladda och förbered
primaromraden <- load_prepared_map("goteborg/primaromraden")
karta <- join_stat_to_map(primaromraden, befolkning, by = "omrade_kod")

# Klassindela
breaks <- create_breaks(karta$oktober, "pretty", 4)
labels <- create_labels(breaks, "range", decimals = 0)
karta$klass <- apply_classification(karta$oktober, breaks, labels)

# Anpassat tema
ggplot(karta, aes(fill = klass)) +
  geom_sf(color = "black", linewidth = 0.1) +
  scale_fill_gbg_sequential("green", n = 4, direction = 1) +
  labs(title = "", fill = "Invånare") +
  theme_gothenburg_map(
    legend_direction = "vertical",
    legend_position = c(0.12, 0.95),  # Uppe till vänster
    panel_background = "#f5f5f5"
  )
```

---

## 7. Sverigekarta - alla kommuner

Nationell nivå istället för Göteborg.

```r
# Ladda Sveriges kommuner
kommuner <- load_prepared_map("sverige/kommuner")

# Exempeldata (ersätt med din data)
kommun_data <- readRDS("examples/data/kommuner_lan.rds")

# Koppla data
karta <- join_stat_to_map(kommuner, kommun_data, by = "kommun_kod")

# Klassindela med fisher (dpih ger ofta för många klasser för kartor)
breaks <- create_breaks(karta$forandring, "fisher", 6)
labels <- create_labels(breaks, "range", decimals = 0)
karta$klass <- apply_classification(karta$forandring, breaks, labels)

# Skapa karta
ggplot(karta, aes(fill = klass)) +
  geom_sf(color = "white", linewidth = 0.05) +
  scale_fill_gbg_diverging("red_green", n = 6) +
  labs(
    title = "Befolkningsförändring i Sveriges kommuner",
    fill = "Förändring",
    caption = "Källa: SCB"
  ) +
  theme_gothenburg_map()
```

---

## 8. Testa olika klassindelningar

Jämför metoder för att hitta bästa klassindelningen.

```r
# Ladda data
primaromraden <- load_prepared_map("goteborg/primaromraden")
karta <- join_stat_to_map(primaromraden, befolkning, by = "omrade_kod")

# 1. Analysera värdena
summarize_for_breaks(karta$forandring, n_classes = 5)

# 2. Jämför metoder visuellt
p <- compare_methods(
  karta$forandring,
  methods = c("fisher", "quantile", "equal"),
  n_classes = 5
)
print(p)
ggsave("output/maps/jamfor_metoder.png", p, width = 10, height = 12)

# 3. Välj metod och skapa karta
breaks <- create_breaks(karta$forandring, "fisher", 5)
labels <- create_labels(breaks, "range", decimals = 0)
karta$klass <- apply_classification(karta$forandring, breaks, labels)

ggplot(karta, aes(fill = klass)) +
  geom_sf(color = "black", linewidth = 0.1) +
  scale_fill_gbg_diverging("red_green", n = 5) +
  labs(title = "Befolkningsförändring") +
  theme_gothenburg_map()
```

---

## 9. DeSO-karta för Göteborg med SCB-data (NYTT!)

Finmaskig karta med DeSO-områden och bostadsdata från SCB.

```r
library(pxweb)
library(tidyr)

# 1. HÄMTA DATA FRÅN SCB
url_address <- "https://api.scb.se/OV0104/v1/doris/sv/ssd/START/BO/BO0104/BO0104X/BO0104T01N2"

deso_uppladelseform_scb <- pxweb_get(
  url = url_address,
  query = list(
    Region = c("*"),
    Upplatelseform = c("*"),
    Tid = "2024",
    ContentsCode = c("*")
  )
)

# 2. BEARBETA DATA
bostader_deso <- as.data.frame(deso_uppladelseform_scb) |>
  pivot_wider(names_from = upplåtelseform, values_from = Antal) |>
  mutate(
    andel_aganderatt = äganderätt / (hyresrätt + bostadsrätt + äganderätt),
    andel_aganderatt_pct = andel_aganderatt * 100  # Till procent
  ) |>
  rename(desokod = region)

# 3. LADDA DESO OCH KOPPLA DATA
deso_gbg <- load_prepared_map("goteborg/deso_goteborg")
# → ~700 DeSO-områden

karta <- join_stat_to_map(deso_gbg, bostader_deso, by = "desokod")
# ✓ Perfekt matchning: 700/700 områden

# 4. KLASSINDELA
# Använd fisher för att hitta naturliga brytpunkter i äganderättsandel
breaks <- create_breaks(karta$andel_aganderatt_pct, "fisher", 5)
labels <- create_labels(breaks, "range", decimals = 0, unit = "%")
karta$klass <- apply_classification(karta$andel_aganderatt_pct, breaks, labels)

# 5. SKAPA KARTA
ggplot(karta, aes(fill = klass)) +
  geom_sf(color = "white", linewidth = 0.05) +
  scale_fill_gbg_sequential("green", n = 5) +
  labs(
    title = "Andel småhus (äganderätt) per DeSO-område",
    subtitle = "Göteborg, ~700 DeSO-områden",
    fill = "Andel småhus (%)",
    caption = "Källa: SCB (2024)"
  ) +
  theme_gothenburg_map()

# 6. SPARA
ggsave("output/maps/deso_gbg_smahus.png", width = 12, height = 10, dpi = 300)
```

---

## 10. RegSO-karta för Göteborg (NYTT!)

Översiktskarta med RegSO-områden (grövre indelning). Aggregerar DeSO-data till RegSO-nivå.

```r
# 1. ANVÄND SAMMA BOSTADSDATA FRÅN EXEMPEL 9
# (se exempel 9 för hur data hämtas från SCB)

# 2. LADDA DESO MED REGSO-KOPPLING
deso_gbg <- load_prepared_map("goteborg/deso_goteborg")
# → Har redan RegSO_2025 kolumn!

# 3. KOPPLA BOSTADSDATA TILL DESO
deso_med_data <- deso_gbg |>
  left_join(bostader_deso, by = "desokod")

# 4. AGGREGERA DESO TILL REGSO-NIVÅ
# Räkna ut totalt antal bostäder per RegSO och andel småhus
regso_data <- deso_med_data |>
  st_drop_geometry() |>
  group_by(RegSO_2025, RegSOkod_2025) |>
  summarise(
    totalt_hyresratt = sum(hyresrätt, na.rm = TRUE),
    totalt_bostadsratt = sum(bostadsrätt, na.rm = TRUE),
    totalt_aganderatt = sum(äganderätt, na.rm = TRUE),
    antal_deso = n()
  ) |>
  mutate(
    andel_aganderatt = totalt_aganderatt / 
      (totalt_hyresratt + totalt_bostadsratt + totalt_aganderatt),
    andel_aganderatt_pct = andel_aganderatt * 100
  )

# 5. LADDA REGSO-GEOMETRI OCH KOPPLA
regso_gbg <- load_prepared_map("goteborg/regso_goteborg")
# → ~90 RegSO-områden

karta <- regso_gbg |>
  left_join(regso_data, by = c("regsonamn" = "RegSO_2025"))

# 6. KLASSINDELA
breaks <- create_breaks(karta$andel_aganderatt_pct, "fisher", 5)
labels <- create_labels(breaks, "range", decimals = 0, unit = "%")
karta$klass <- apply_classification(karta$andel_aganderatt_pct, breaks, labels)

# 7. SKAPA KARTA
ggplot(karta, aes(fill = klass)) +
  geom_sf(color = "white", linewidth = 0.2) +
  scale_fill_gbg_sequential("green", n = 5) +
  labs(
    title = "Andel småhus (äganderätt) per RegSO-område",
    subtitle = "Göteborg, ~90 RegSO-områden (aggregerat från DeSO)",
    fill = "Andel småhus (%)",
    caption = "Källa: SCB (2024)"
  ) +
  theme_gothenburg_map()

# 8. SPARA
ggsave("output/maps/regso_gbg_smahus.png", width = 12, height = 10, dpi = 300)
```

**TIPS:** RegSO är grövre → lättare att se övergripande mönster än DeSO.

---

## 11. DeSO Göteborgsregionen med kommunfärger (NYTT!)

Visa DeSO-områden i Göteborgsregionens 13 kommuner med olika färger per kommun och bostadsdata.

```r
# 1. ANVÄND SAMMA BOSTADSDATA FRÅN EXEMPEL 9
# (se exempel 9 för hur data hämtas från SCB)

# 2. LADDA DESO FÖR GÖTEBORGSREGIONEN
deso_gr <- load_prepared_map("sverige/deso_gr")
# → ~2400 DeSO-områden i 13 kommuner

# 3. KOPPLA BOSTADSDATA
karta <- join_stat_to_map(deso_gr, bostader_deso, by = "desokod")

# 4. DEFINIERA FÄRGER PER KOMMUN
# Göteborg: Göteborgsblå
# Närliggande (Härryda, Mölndal, Partille, Kungälv, Lerum): dark_colors
# Övriga 7: light_colors

kommunfarger <- c(
  "1480" = "#0076bc",      # Göteborg - Göteborgsblå
  "1401" = "#084b83",      # Härryda - dark_blue
  "1481" = "#6b2c5c",      # Mölndal - dark_purple
  "1402" = "#8b5c10",      # Partille - dark_orange
  "1482" = "#005f51",      # Kungälv - dark_green
  "1441" = "#a4343a",      # Lerum - dark_red
  "1440" = "#b3d9ff",      # Ale - light_blue
  "1489" = "#d9c3d9",      # Alingsås - light_purple
  "1384" = "#ffd699",      # Kungsbacka - light_orange
  "1462" = "#a6d9cc",      # Lilla Edet - light_green
  "1415" = "#ffb3b3",      # Stenungsund - light_red
  "1419" = "#c2e0f2",      # Tjörn - light_cyan
  "1407" = "#ffe6cc"       # Öckerö - light_peach
)

# 5. SKAPA KARTA - KOMMUNÖVERSIKT
ggplot(karta, aes(fill = kommunkod)) +
  geom_sf(color = "white", linewidth = 0.02) +
  scale_fill_manual(
    values = kommunfarger,
    labels = c(
      "1480" = "Göteborg",
      "1401" = "Härryda",
      "1481" = "Mölndal",
      "1402" = "Partille",
      "1482" = "Kungälv",
      "1441" = "Lerum",
      "1440" = "Ale",
      "1489" = "Alingsås",
      "1384" = "Kungsbacka",
      "1462" = "Lilla Edet",
      "1415" = "Stenungsund",
      "1419" = "Tjörn",
      "1407" = "Öckerö"
    )
  ) +
  labs(
    title = "DeSO-områden i Göteborgsregionen",
    subtitle = "~2400 områden i 13 kommuner",
    fill = "Kommun",
    caption = "Källa: SCB"
  ) +
  theme_gothenburg_map() +
  theme(legend.position = "right")

# 6. ALTERNATIV: KARTA MED SMÅHUSANDEL
# Klassindela andel småhus
breaks <- create_breaks(karta$andel_aganderatt_pct, "fisher", 6)
labels <- create_labels(breaks, "range", decimals = 0, unit = "%")
karta$klass <- apply_classification(karta$andel_aganderatt_pct, breaks, labels)

ggplot(karta, aes(fill = klass)) +
  geom_sf(color = "white", linewidth = 0.02) +
  scale_fill_gbg_sequential("green", n = 6) +
  labs(
    title = "Andel småhus i Göteborgsregionen",
    subtitle = "DeSO-områden (~2400), klassificering: Fisher",
    fill = "Andel småhus (%)",
    caption = "Källa: SCB (2024)"
  ) +
  theme_gothenburg_map()

# 7. SPARA
ggsave("output/maps/deso_gr_kommuner.png", width = 12, height = 10, dpi = 300)
```

---

## 12. RegSO Göteborgsregionen med kommunfärger (NYTT!)

Översiktskarta med RegSO-områden i Göteborgsregionen (grövre indelning).

```r
# 1. ANVÄND SAMMA BOSTADSDATA FRÅN EXEMPEL 9

# 2. LADDA DESO OCH AGGREGERA TILL REGSO
deso_gr <- load_prepared_map("sverige/deso_gr")

# Koppla bostadsdata till DeSO
deso_med_data <- deso_gr |>
  left_join(bostader_deso, by = "desokod")

# Aggregera till RegSO-nivå
regso_data <- deso_med_data |>
  st_drop_geometry() |>
  group_by(RegSO_2025, RegSOkod_2025, kommunkod, kommunnamn) |>
  summarise(
    totalt_hyresratt = sum(hyresrätt, na.rm = TRUE),
    totalt_bostadsratt = sum(bostadsrätt, na.rm = TRUE),
    totalt_aganderatt = sum(äganderätt, na.rm = TRUE),
    antal_deso = n()
  ) |>
  mutate(
    andel_aganderatt = totalt_aganderatt / 
      (totalt_hyresratt + totalt_bostadsratt + totalt_aganderatt),
    andel_aganderatt_pct = andel_aganderatt * 100
  )

# 3. LADDA REGSO-GEOMETRI OCH KOPPLA
regso_gr <- load_prepared_map("sverige/regso_gr")
# → ~300 RegSO-områden i 13 kommuner

karta <- regso_gr |>
  left_join(regso_data, by = c("regsonamn" = "RegSO_2025"))

# 4. ANVÄND SAMMA KOMMUNFÄRGER SOM EXEMPEL 11
kommunfarger <- c(
  "1480" = "#0076bc",      # Göteborg - Göteborgsblå
  "1401" = "#084b83",      # Härryda - dark_blue
  "1481" = "#6b2c5c",      # Mölndal - dark_purple
  "1402" = "#8b5c10",      # Partille - dark_orange
  "1482" = "#005f51",      # Kungälv - dark_green
  "1441" = "#a4343a",      # Lerum - dark_red
  "1440" = "#b3d9ff",      # Ale - light_blue
  "1489" = "#d9c3d9",      # Alingsås - light_purple
  "1384" = "#ffd699",      # Kungsbacka - light_orange
  "1462" = "#a6d9cc",      # Lilla Edet - light_green
  "1415" = "#ffb3b3",      # Stenungsund - light_red
  "1419" = "#c2e0f2",      # Tjörn - light_cyan
  "1407" = "#ffe6cc"       # Öckerö - light_peach
)

# 5. SKAPA KARTA - KOMMUNÖVERSIKT
ggplot(karta, aes(fill = kommunkod)) +
  geom_sf(color = "white", linewidth = 0.1) +
  scale_fill_manual(
    values = kommunfarger,
    labels = c(
      "1480" = "Göteborg",
      "1401" = "Härryda",
      "1481" = "Mölndal",
      "1402" = "Partille",
      "1482" = "Kungälv",
      "1441" = "Lerum",
      "1440" = "Ale",
      "1489" = "Alingsås",
      "1384" = "Kungsbacka",
      "1462" = "Lilla Edet",
      "1415" = "Stenungsund",
      "1419" = "Tjörn",
      "1407" = "Öckerö"
    )
  ) +
  labs(
    title = "RegSO-områden i Göteborgsregionen",
    subtitle = "~300 områden i 13 kommuner (grövre indelning än DeSO)",
    fill = "Kommun",
    caption = "Källa: SCB"
  ) +
  theme_gothenburg_map() +
  theme(
    legend.position = "right",
    legend.key.size = unit(0.5, "cm")
  )

# 6. ALTERNATIV: KARTA MED SMÅHUSANDEL
breaks <- create_breaks(karta$andel_aganderatt_pct, "fisher", 6)
labels <- create_labels(breaks, "range", decimals = 0, unit = "%")
karta$klass <- apply_classification(karta$andel_aganderatt_pct, breaks, labels)

ggplot(karta, aes(fill = klass)) +
  geom_sf(color = "white", linewidth = 0.1) +
  scale_fill_gbg_sequential("green", n = 6) +
  labs(
    title = "Andel småhus i Göteborgsregionen (RegSO-nivå)",
    subtitle = "~300 RegSO-områden (aggregerat från DeSO)",
    fill = "Andel småhus (%)",
    caption = "Källa: SCB (2024)"
  ) +
  theme_gothenburg_map()

# 7. SPARA
ggsave("output/maps/regso_gr_kommuner.png", width = 12, height = 10, dpi = 300)
```

**JÄMFÖRELSE DeSO vs RegSO:**
- **DeSO**: ~2400 områden → mer detaljer, längre renderingstid
- **RegSO**: ~300 områden → övergripande mönster, snabbare
- Välj baserat på syfte: analys (DeSO) eller presentation (RegSO)

---

## Tips

**SCB-data med pxweb:**
- Använd `pxweb` för att hämta DeSO-statistik direkt från SCB
- DeSO-kod i SCB heter `region` → byt namn till `desokod`
- Aggregera till RegSO: använd DeSO:s RegSO_2025-kolumn

**DeSO vs RegSO:**
- **DeSO** (~700 i Göteborg, ~2400 i GR): Använd för detaljerade analyser
- **RegSO** (~90 i Göteborg, ~300 i GR): Använd för översiktskartor
- Aggregera alltid DeSO→RegSO, aldrig tvärtom

**Klassindelning:**
- Börja med `fisher` (bästa natural breaks)
- Använd `quantile` för skev data
- Testa `dpih` eller `headtails` om osäker på antal klasser **men**:
  - dpih kan ge MÅNGA klasser (100+) för stora dataset
  - Bättre för histogram än kartor
  - För kartor: använd fisher/quantile med 5-7 klasser
- Använd `compare_methods()` för att jämföra

**Färgpaletter:**
- Sequential: Värden från låg till hög
- Diverging: Avvikelser från neutral punkt (0, medel)
- Categorical: Kategorier utan inbördes ordning

**Antal klasser:**
- 5-6 är standard för choropleth
- Max 7 för categorical
- dpih/headtails/box väljer själva (kan bli många!)
- För kartor: håll dig till 5-7 klasser för läsbarhet

**Extra lager:**
- Rita vatten FÖRE kartdata (så det hamnar under)
- Rita gränser EFTER kartdata (så de syns ovanpå)
- Använd `fill = NA` för transparenta gränser

**DeSO/RegSO:**
- DeSO har RegSO-info redan: `deso_gbg$RegSO_2025`
- Aggregera DeSO till RegSO: `group_by(RegSO_2025)`
- Filtrera kommun: `filter(kommunkod == "1480")`

---

**Version:** 2.0  
**Uppdaterad:** 2025-12-16  
**Nytt:** DeSO/RegSO-exempel (9-12)