# üìñ Geodata - Ladda och hantera kartlager

Funktioner f√∂r att ladda f√∂rberedda kartlager och koppla statistik.

---

## Inneh√•llsf√∂rteckning

1. [load_prepared_map()](#load_prepared_map) - Ladda kartlager
2. [load_water_layer()](#load_water_layer) - Ladda vattenlager  
3. [join_stat_to_map()](#join_stat_to_map) - Koppla statistik till karta
4. [list_prepared_maps()](#list_prepared_maps) - Lista tillg√§ngliga kartlager
5. [join_points_to_areas()](#join_points_to_areas) - Koppla punkter till omr√•den

---

## load_prepared_map() {#load_prepared_map}

### Beskrivning

L√§ser in ett f√∂rberett kartlager i rds-format. Snabbare √§n att l√§sa shapefiler varje g√•ng.

### Syntax

```r
load_prepared_map(map_name, data_dir = "input/prepared_maps")
```

### Parametrar

- **map_name** (character): Namn p√• kartlagret med mapp (utan .rds-suffix)
  - Format: `"mapp/filnamn"`
  - Exempel: `"goteborg/primaromraden"`, `"sverige/kommuner"`
- **data_dir** (character): Mapp d√§r f√∂rberedda kartlager finns (default: `"input/prepared_maps"`)

### Returnerar

sf-objekt med kartgeometrier

### Tillg√§ngliga kartlager

#### G√∂teborg
- `"goteborg/primaromraden"` - Prim√§romr√•den
- `"goteborg/stadsdelar"` - Stadsdelar
- `"goteborg/basomraden"` - Basomr√•den
- `"goteborg/kommungrans"` - Kommungr√§ns

#### Sverige
- `"sverige/kommuner"` - Sveriges kommuner
- `"sverige/lan"` - Sveriges l√§n
- `"sverige/regioner"` - Sveriges regioner

### Exempel

```r
# G√∂teborg
primaromraden <- load_prepared_map("goteborg/primaromraden")
# ‚Üí sf-objekt med 96 prim√§romr√•den

stadsdelar <- load_prepared_map("goteborg/stadsdelar")
# ‚Üí sf-objekt med 21 stadsdelar

# Sverige
kommuner <- load_prepared_map("sverige/kommuner")
# ‚Üí sf-objekt med 290 kommuner

lan <- load_prepared_map("sverige/lan")
# ‚Üí sf-objekt med 21 l√§n

# Enkel preview
plot(st_geometry(primaromraden))
```

### Best Practices

```r
# Spara ofta anv√§nda lager i variabler
goteborg_primaromraden <- load_prepared_map("goteborg/primaromraden")
goteborg_stadsdelar <- load_prepared_map("goteborg/stadsdelar")

# Anv√§nd sedan direkt
ggplot(goteborg_primaromraden) +
  geom_sf() +
  theme_void()
```

### Felhantering

```r
# Fel kartnamn
load_prepared_map("felaktigt_namn")
# Error: Kartlager finns inte: input/prepared_maps/felaktigt_namn.rds
# Tillg√§ngliga kartlager: ...

# Fel mapp
load_prepared_map("primaromraden")  # Gl√∂mde goteborg/
# Error: Kartlager finns inte: input/prepared_maps/primaromraden.rds
```

---

## load_water_layer() {#load_water_layer}

### Beskrivning

L√§ser in f√∂rberedda vattenlager (√§lvar, sj√∂ar, hav) f√∂r visualisering. Vatten renderas ofta annorlunda √§n √∂vrig geografi.

### Syntax

```r
load_water_layer(water_name, data_dir = "input/prepared_maps")
```

### Parametrar

- **water_name** (character): Namn p√• vattenlagret med mapp (utan .rds-suffix)
- **data_dir** (character): Mapp d√§r f√∂rberedda vattenlager finns (default: `"input/prepared_maps"`)

### Returnerar

sf-objekt med vattengeometrier, eller NULL om fil saknas

### Tillg√§ngliga vattenlager

#### G√∂teborg
- `"goteborg/alv_goteborg"` - G√∂ta √§lv
- `"goteborg/hav_goteborg"` - Havsomr√•den

#### Sverige
- `"sverige/vatten_sverige"` - Vatten (sj√∂ar och √§lvar)
- `"sverige/kust_sverige"` - Kustn√§ra vatten

### Exempel

```r
# Ladda √§lv
alv <- load_water_layer("goteborg/alv_goteborg")

# Ladda hav
hav <- load_water_layer("goteborg/hav_goteborg")

# Kombinera med karta
primaromraden <- load_prepared_map("goteborg/primaromraden")

ggplot() +
  geom_sf(data = primaromraden, fill = "lightgray") +
  geom_sf(data = alv, fill = "#b3d9ff", color = NA) +
  theme_void()
```

### Best Practices

#### R√§tt lagerordning

```r
# R√ÑTT ordning: vatten OVANP√Ö kartlager
ggplot() +
  geom_sf(data = primaromraden, aes(fill = befolkning)) +  # 1. Karta
  geom_sf(data = alv, fill = "#b3d9ff", color = NA) +     # 2. Vatten
  geom_sf(data = grans, fill = NA, color = "black") +      # 3. Gr√§nser
  scale_fill_gbg_sequential("blue", n = 5)

# FEL ordning: vatten under
ggplot() +
  geom_sf(data = alv, fill = "#b3d9ff", color = NA) +     # Syns inte!
  geom_sf(data = primaromraden, aes(fill = befolkning))
```

#### Standard vattenf√§rg

```r
# Anv√§nd ljusbl√• f√∂r vatten
vatten_farg <- "#b3d9ff"  # Ljusbl√• fr√•n G√∂teborgs palett

geom_sf(data = alv, fill = vatten_farg, color = NA)
```

### Felhantering

```r
# Saknas fil - returnerar NULL och varning
vatten <- load_water_layer("goteborg/finns_inte")
# Warning: Vattenlager finns inte: ...
# ‚Üí NULL

# Hantera NULL
if (!is.null(vatten)) {
  geom_sf(data = vatten, fill = "#b3d9ff")
}
```

---

## join_stat_to_map() {#join_stat_to_map}

### Beskrivning

Kopplar tabelldatak√§llor (CSV, Excel, dataframe) till kartgeometrier. S√§kerst√§ller matchning mellan data och geografi.

### Syntax

```r
join_stat_to_map(
  map_data, 
  stat_data, 
  by = NULL,
  by_map = NULL, 
  by_stat = NULL
)
```

### Parametrar

- **map_data** (sf): sf-objekt med kartgeometrier
- **stat_data** (data.frame): Statistikdata
- **by** (character, valfritt): Kolumnnamn att matcha p√• (om samma i b√•da)
- **by_map** (character, valfritt): Kolumnnamn i map_data (om olika)
- **by_stat** (character, valfritt): Kolumnnamn i stat_data (om olika)

### Returnerar

sf-objekt med b√•de geometri och statistik

### Exempel

#### Enkel matchning (samma kolumnnamn)

```r
# Ladda data
primaromraden <- load_prepared_map("goteborg/primaromraden")
befolkning <- read_csv("data/befolkning.csv")

# Koppla
karta <- join_stat_to_map(
  map_data = primaromraden,
  stat_data = befolkning,
  by = "omrade_kod"
)

# Nu har karta b√•de geometri och statistik
names(karta)
# ‚Üí c("omrade_kod", "omrade_namn", "befolkning", "forandring", "geometry")
```

#### Olika kolumnnamn

```r
# Kommundata med olika kolumnnamn
kommuner <- load_prepared_map("sverige/kommuner")
scb_data <- read_csv("data/scb_befolkning.csv")

karta <- join_stat_to_map(
  map_data = kommuner,
  stat_data = scb_data,
  by_map = "kommun_kod",  # Kolumn i kommuner
  by_stat = "kod"          # Kolumn i scb_data
)
```

#### Med mellansteg

```r
# 1. Ladda separat
primaromraden <- load_prepared_map("goteborg/primaromraden")
befolkning <- read_csv("data/befolkning.csv")

# 2. Inspektera f√∂re koppling
head(primaromraden)
head(befolkning)

# 3. Koppla
karta <- join_stat_to_map(primaromraden, befolkning, by = "omrade_kod")

# 4. Verifiera
nrow(primaromraden)  # 96
nrow(karta)          # 96 (samma)
```

### Matchningsstatus

Funktionen visar automatiskt matchningsstatus:

```r
karta <- join_stat_to_map(primaromraden, befolkning, by = "omrade_kod")
# Matchar p√• kolumn: 'omrade_kod' = 'omrade_kod'
#   Formaterade matchningskolumner till text
# ‚úì Perfekt matchning: 96/96 omr√•den (100%)
#   ‚úì 96 omr√•den efter merge
```

#### Bra matchning (95-100%)
```
‚úì Bra matchning: 91/96 omr√•den (94.8%)
  Info: 5 omr√•den i kartan finns inte i statistiken:
    Omr√•de_A, Omr√•de_B, ...
```

#### D√•lig matchning (<80%)
```
‚ùå D√•lig matchning: 70/96 omr√•den (72.9%)
  Info: 26 omr√•den i kartan finns inte i statistiken
  Info: 15 v√§rden i statistiken finns inte i kartlagret
```

### Best Practices

#### 1. Kontrollera kolumnnamn f√∂rst

```r
# Vilka kolumner finns?
names(primaromraden)
# ‚Üí c("omrade_kod", "omrade_namn", "geometry")

names(befolkning)
# ‚Üí c("omrade_kod", "befolkning", "forandring")

# Nu vet vi att "omrade_kod" √§r gemensam
```

#### 2. Inspektera matchning

```r
karta <- join_stat_to_map(primaromraden, befolkning, by = "omrade_kod")

# Hur m√•nga NA-v√§rden?
sum(is.na(karta$befolkning))
# ‚Üí 0 (perfekt!)

# Vilka saknas?
karta[is.na(karta$befolkning), c("omrade_kod", "omrade_namn")]
```

#### 3. Hantera d√•lig matchning

```r
# Problem: olika formattering av koder
# Map: "001", "002", ...
# Stat: "1", "2", ...

# L√∂sning: formatera innan join
befolkning <- befolkning |>
  mutate(omrade_kod = str_pad(omrade_kod, width = 3, pad = "0"))

karta <- join_stat_to_map(primaromraden, befolkning, by = "omrade_kod")
```

### Anv√§ndningsomr√•den

#### 1. Befolkningskartor

```r
karta <- join_stat_to_map(primaromraden, befolkning, by = "omrade_kod")

ggplot(karta, aes(fill = befolkning)) +
  geom_sf() +
  scale_fill_gbg_sequential("blue")
```

#### 2. Tidsserie-data

```r
# Flera √•rtal i samma statistikfil
befolkning_2020_2025 <- read_csv("data/befolkning_tidserie.csv")

karta_2025 <- join_stat_to_map(
  primaromraden,
  befolkning_2020_2025 |> filter(ar == 2025),
  by = "omrade_kod"
)
```

#### 3. Flera variabler

```r
statistik <- read_csv("data/sammanstallning.csv")
# Inneh√•ller: befolkning, inkomst, utbildning, ...

karta <- join_stat_to_map(primaromraden, statistik, by = "omrade_kod")

# Nu kan vi kartl√§gga vilken variabel som helst
ggplot(karta, aes(fill = inkomst)) + geom_sf()
ggplot(karta, aes(fill = utbildning)) + geom_sf()
```

### Felhantering

```r
# Fel kolumnnamn
join_stat_to_map(primaromraden, befolkning, by = "fel_kolumn")
# Error: Kolumnen 'fel_kolumn' finns inte i map_data

# Gl√∂mde ange by
join_stat_to_map(primaromraden, befolkning)
# Error: M√•ste ange antingen 'by' (om samma kolumnnamn)
# eller b√•de 'by_map' och 'by_stat' (om olika kolumnnamn)

# Inte sf-objekt
join_stat_to_map(befolkning, primaromraden, by = "omrade_kod")
# Error: map_data m√•ste vara ett sf-objekt
```

---

## list_prepared_maps() {#list_prepared_maps}

### Beskrivning

Visar information om alla f√∂rberedda kartlager i en tabell. Hj√§lper dig att hitta r√§tt kartlager.

### Syntax

```r
list_prepared_maps(data_dir = "input/prepared_maps", pattern = "\\.rds$")
```

### Parametrar

- **data_dir** (character): Mapp att s√∂ka i (default: `"input/prepared_maps"`)
- **pattern** (character): Regex f√∂r filtyp (default: `"\\.rds$"`)

### Returnerar

Data.frame med information om tillg√§ngliga kartlager

### Exempel

```r
# Lista alla
kartlager <- list_prepared_maps()

# Se i R
View(kartlager)

# Eller kolla i konsol
print(kartlager)
#   map_name                      file_name               size_kb  n_areas
#   goteborg/basomraden           basomraden.rds         245.3    628
#   goteborg/primaromraden        primaromraden.rds      89.1     96
#   goteborg/stadsdelar           stadsdelar.rds         34.2     21
#   sverige/kommuner              kommuner.rds           1234.5   290
```

### Anv√§ndningsomr√•den

#### 1. Hitta r√§tt kartlager

```r
# Vad finns f√∂r G√∂teborg?
kartlager <- list_prepared_maps()
kartlager |> filter(str_detect(map_name, "goteborg"))

# Stora filer?
kartlager |> filter(size_kb > 500)
```

#### 2. Dokumentation

```r
# Spara lista f√∂r dokumentation
kartlager <- list_prepared_maps()
write_csv(kartlager, "docs/tillgangliga_kartlager.csv")
```

---

## join_points_to_areas() {#join_points_to_areas}

### Beskrivning

Spatial join - kopplar punkter (t.ex. skolor, aff√§rer) till polygon-omr√•den och r√§knar antal per omr√•de.

### Syntax

```r
join_points_to_areas(polygons, points, count_column = "n_points")
```

### Parametrar

- **polygons** (sf): sf-objekt med omr√•den (polygon)
- **points** (sf): sf-objekt med punkter
- **count_column** (character): Namn p√• ny kolumn f√∂r antal (default: `"n_points"`)

### Returnerar

sf-objekt (polygons) med ny kolumn f√∂r antal punkter

### Exempel

```r
# R√§kna skolor per stadsdel
stadsdelar <- load_prepared_map("goteborg/stadsdelar")
skolor <- st_read("data/skolor.shp")

stadsdelar_skolor <- join_points_to_areas(
  stadsdelar, 
  skolor, 
  "antal_skolor"
)

# Visualisera
ggplot(stadsdelar_skolor, aes(fill = antal_skolor)) +
  geom_sf() +
  scale_fill_gbg_sequential("blue")
```

---

**Version:** 1.0  
**Uppdaterad:** 2025-12-11  
**F√∂r:** geodata.R
