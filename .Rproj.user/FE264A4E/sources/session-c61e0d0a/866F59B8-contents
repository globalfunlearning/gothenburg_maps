# =============================================================================
# SKAPA F√ñRBEREDDA DESO OCH REGSO 2025 KARTLAGER - FIXAD VERSION
# =============================================================================
#
# FIXAT: Hanterar SCB:s faktiska kolumnnamn (desokod, regsokod, kommunkod)
#
# =============================================================================

library(sf)
library(dplyr)
library(readxl)

# Ladda funktioner
source("R/geodata.R")

# =============================================================================
# STEG 1: DEFINIERA KOMMUNER
# =============================================================================

# G√∂teborg
GOTEBORG_KOD <- "1480"

# G√∂teborgsregionens 13 kommuner
  GR_KOMMUNER <- c(
    "1440",  # Ale        
    "1489",  # Alings√•s   
    "1480",  # G√∂teborg   
    "1401",  # H√§rryda    
    "1384",  # Kungsbacka 
    "1482",  # Kung√§lv   
    "1441",  # Lerum     
    "1462",  # Lilla Edet 
    "1481",  # M√∂lndal    
    "1402",  # Partille   
    "1415",  # Stenungsund
    "1419",  # Tj√∂rn      
    "1407"   # √ñcker√∂     
)

# =============================================================================
# STEG 2: LADDA DATA FR√ÖN SCB
# =============================================================================

message("\n=== LADDAR DATA FR√ÖN SCB (2025 √ÖRS VERSION) ===\n")

# Ladda DeSO 2025
message("1/3: DeSO 2025...")
deso_alla <- load_deso_from_scb()

# Ladda RegSO 2025
message("\n2/3: RegSO 2025...")
regso_alla <- load_regso_from_scb()

# Ladda kopplingstabell
message("\n3/3: Kopplingstabell DeSO-RegSO...")
koppling <- load_deso_regso_koppling()

# =============================================================================
# STEG 3: KOPPLA REGSO-INFO TILL DESO
# =============================================================================

message("\n=== KOPPLAR REGSO-INFO TILL DESO ===\n")

# Visa kolumnnamn
message("Kolumner i DeSO-data: ", paste(names(deso_alla), collapse = ", "))
message("Kolumner i koppling: ", paste(names(koppling), collapse = ", "))

# IDENTIFIERA KOLUMNNAMN
# VARF√ñR?: SCB anv√§nder gemener (desokod, regsokod, kommunkod)

# DeSO-kolumn
deso_col <- NULL
possible_deso <- c("desokod", "deso", "DeSO", "DeSO_2025", "deso_2025", "DESO")

for (col in possible_deso) {
  if (col %in% names(deso_alla)) {
    deso_col <- col
    break
  }
}

if (is.null(deso_col)) {
  stop("Kunde inte hitta DeSO-kolumn. Tillg√§ngliga: ", 
       paste(names(deso_alla), collapse = ", "))
}

# Kommun-kolumn
kommun_col <- NULL
possible_kommun <- c("kommunkod", "kommun", "Kommun", "kommun_kod")

for (col in possible_kommun) {
  if (col %in% names(deso_alla)) {
    kommun_col <- col
    break
  }
}

if (is.null(kommun_col)) {
  stop("Kunde inte hitta kommun-kolumn. Tillg√§ngliga: ", 
       paste(names(deso_alla), collapse = ", "))
}

message("‚úì Anv√§nder kolumner:")
message("  DeSO: '", deso_col, "'")
message("  Kommun: '", kommun_col, "'")

# KOPPLA REGSO-INFO TILL DESO
# VARF√ñR left_join?: Beh√•ller alla DeSO √§ven om koppling saknas

# OBS: DeSO-data har redan regsokod, men vi vill ha RegSO-namn fr√•n kopplingstabellen
deso_alla <- deso_alla |>
  left_join(
    koppling |>
      select(DeSO_2025, RegSO_2025, RegSOkod_2025),  # V√§lj relevanta kolumner
    by = setNames("DeSO_2025", deso_col)
  )

# Kontrollera koppling
n_med_regso_namn <- sum(!is.na(deso_alla$RegSO_2025))
koppling_pct <- round(n_med_regso_namn / nrow(deso_alla) * 100, 1)

message("‚úì Kopplade RegSO-namn till DeSO")
message("  ", n_med_regso_namn, "/", nrow(deso_alla), " DeSO har RegSO-namn (", 
        koppling_pct, "%)")

if (koppling_pct < 100) {
  n_saknas <- nrow(deso_alla) - n_med_regso_namn
  warning("  ", n_saknas, " DeSO-omr√•den saknar RegSO-namn fr√•n kopplingstabellen")
}

# Visa exempel p√• data
message("\nExempel p√• f√∂rsta raden:")
message("  DeSO-kod (", deso_col, "): ", deso_alla[[deso_col]][1])
message("  RegSO-kod (regsokod): ", deso_alla$regsokod[1])
message("  RegSO-namn (RegSO_2025): ", 
        if (!is.na(deso_alla$RegSO_2025[1])) deso_alla$RegSO_2025[1] else "saknas")

# =============================================================================
# STEG 4: FILTRERA TILL G√ñTEBORG
# =============================================================================

message("\n=== FILTRERAR TILL G√ñTEBORG ===\n")

# DeSO G√∂teborg (med RegSO-info)
deso_goteborg <- deso_alla |>
  filter(.data[[kommun_col]] == GOTEBORG_KOD)

message("‚úì DeSO G√∂teborg: ", nrow(deso_goteborg), " omr√•den")
message("  Kolumner: ", paste(names(deso_goteborg), collapse = ", "))

# Kontrollera RegSO-t√§ckning i G√∂teborg
n_gbg_regso <- sum(!is.na(deso_goteborg$RegSO_2025))
message("  ‚Üí ", n_gbg_regso, " av ", nrow(deso_goteborg), 
        " har RegSO-namn (", round(n_gbg_regso/nrow(deso_goteborg)*100, 1), "%)")

# RegSO G√∂teborg
regso_goteborg <- regso_alla |>
  filter(.data[[kommun_col]] == GOTEBORG_KOD)

message("‚úì RegSO G√∂teborg: ", nrow(regso_goteborg), " omr√•den")

# =============================================================================
# STEG 5: FILTRERA TILL G√ñTEBORGSREGIONEN
# =============================================================================

message("\n=== FILTRERAR TILL G√ñTEBORGSREGIONEN (13 KOMMUNER) ===\n")

# DeSO GR (med RegSO-info)
deso_gr <- deso_alla |>
  filter(.data[[kommun_col]] %in% GR_KOMMUNER)

message("‚úì DeSO GR: ", nrow(deso_gr), " omr√•den i ", length(GR_KOMMUNER), " kommuner")

# Kontrollera RegSO-t√§ckning i GR
n_gr_regso <- sum(!is.na(deso_gr$RegSO_2025))
message("  ‚Üí ", n_gr_regso, " av ", nrow(deso_gr), 
        " har RegSO-namn (", round(n_gr_regso/nrow(deso_gr)*100, 1), "%)")

# RegSO GR
regso_gr <- regso_alla |>
  filter(.data[[kommun_col]] %in% GR_KOMMUNER)

message("‚úì RegSO GR: ", nrow(regso_gr), " omr√•den i ", length(GR_KOMMUNER), " kommuner")

# =============================================================================
# STEG 6: SPARA SOM .RDS-FILER
# =============================================================================

message("\n=== SPARAR F√ñRBEREDDA KARTLAGER ===\n")

# Skapa mappar
dir.create("input/prepared_maps/goteborg", recursive = TRUE, showWarnings = FALSE)
dir.create("input/prepared_maps/sverige", recursive = TRUE, showWarnings = FALSE)

# 1. DeSO G√∂teborg
saveRDS(deso_goteborg, "input/prepared_maps/goteborg/deso_goteborg.rds")
message("‚úì Sparad: input/prepared_maps/goteborg/deso_goteborg.rds")
message("  Storlek: ", round(file.size("input/prepared_maps/goteborg/deso_goteborg.rds")/1024, 1), " KB")

# 2. RegSO G√∂teborg
saveRDS(regso_goteborg, "input/prepared_maps/goteborg/regso_goteborg.rds")
message("‚úì Sparad: input/prepared_maps/goteborg/regso_goteborg.rds")

# 3. DeSO GR
saveRDS(deso_gr, "input/prepared_maps/sverige/deso_gr.rds")
message("‚úì Sparad: input/prepared_maps/sverige/deso_gr.rds")
message("  Storlek: ", round(file.size("input/prepared_maps/sverige/deso_gr.rds")/1024, 1), " KB")

# 4. RegSO GR
saveRDS(regso_gr, "input/prepared_maps/sverige/regso_gr.rds")
message("‚úì Sparad: input/prepared_maps/sverige/regso_gr.rds")

# =============================================================================
# STEG 7: SAMMANFATTNING
# =============================================================================

message("\n", strrep("=", 70))
message("SAMMANFATTNING")
message(strrep("=", 70))

cat("\nSkapade 4 f√∂rberedda kartlager (DeSO 2025 & RegSO 2025):\n\n")

cat("G√ñTEBORG:\n")
cat("  - deso_goteborg.rds:  ", nrow(deso_goteborg), " DeSO-omr√•den\n")
cat("    Kolumner: desokod, regsokod, kommunkod, kommunnamn,\n")
cat("              RegSO_2025 (namn), RegSOkod_2025 (kod), geometry\n")
cat("  - regso_goteborg.rds: ", nrow(regso_goteborg), " RegSO-omr√•den\n\n")

cat("G√ñTEBORGSREGIONEN (13 kommuner):\n")
cat("  - deso_gr.rds:        ", nrow(deso_gr), " DeSO-omr√•den\n")
cat("    Kolumner: desokod, regsokod, kommunkod, kommunnamn,\n")
cat("              RegSO_2025 (namn), RegSOkod_2025 (kod), geometry\n")
cat("  - regso_gr.rds:       ", nrow(regso_gr), " RegSO-omr√•den\n\n")

cat("ANV√ÑNDNING:\n")
cat("  # Ladda f√∂rberedda lager:\n")
cat("  deso_gbg <- load_prepared_map(\"goteborg/deso_goteborg\")\n")
cat("  \n")
cat("  # Tillg√§ngliga kolumner:\n")
cat("  names(deso_gbg)\n")
cat("  # ‚Üí desokod, regsokod, kommunkod, kommunnamn,\n")
cat("  #   RegSO_2025, RegSOkod_2025, geometry\n\n")

cat("EXEMPEL - Aggregera DeSO till RegSO:\n")
cat("  deso_gbg %>%\n")
cat("    st_drop_geometry() %>%\n")
cat("    group_by(RegSO_2025, regsokod) %>%\n")
cat("    summarise(\n")
cat("      antal_deso = n(),\n")
cat("      befolkning_tot = sum(befolkning, na.rm = TRUE)\n")
cat("    )\n\n")

cat("EXEMPEL - Karta f√§rgad efter RegSO:\n")
cat("  ggplot(deso_gbg, aes(fill = RegSO_2025)) +\n")
cat("    geom_sf(color = \"white\", linewidth = 0.05) +\n")
cat("    labs(title = \"DeSO-omr√•den f√§rgade efter RegSO\") +\n")
cat("    theme_void()\n\n")

message(strrep("=", 70))
cat("\n‚úì KLART! DeSO 2025 och RegSO 2025 √§r redo att anv√§nda. üéâ\n\n")

# =============================================================================
# STEG 8: PREVIEW-KARTOR
# =============================================================================

message("=== SKAPAR PREVIEW-KARTOR ===\n")

library(ggplot2)

dir.create("output", showWarnings = FALSE)

# 1. DeSO G√∂teborg f√§rgad efter RegSO
p1 <- ggplot(deso_goteborg) +
  geom_sf(aes(fill = RegSO_2025), color = "white", linewidth = 0.05) +
  labs(
    title = "DeSO 2025 - G√∂teborg",
    subtitle = paste(nrow(deso_goteborg), "DeSO-omr√•den f√§rgade efter RegSO"),
    fill = "RegSO-omr√•de"
  ) +
  theme_void() +
  theme(
    legend.position = "right",
    legend.key.size = unit(0.4, "cm"),
    legend.text = element_text(size = 7)
  )

ggsave("output/preview_deso_goteborg_2025.png", p1, 
       width = 10, height = 10, dpi = 150)
message("‚úì output/preview_deso_goteborg_2025.png")

# 2. DeSO GR f√§rgad efter kommun
p2 <- ggplot(deso_gr) +
  geom_sf(aes(fill = kommunnamn), color = "white", linewidth = 0.02) +
  labs(
    title = "DeSO 2025 - G√∂teborgsregionen",
    subtitle = paste(nrow(deso_gr), "DeSO-omr√•den i 13 kommuner"),
    fill = "Kommun"
  ) +
  theme_void() +
  theme(legend.position = "right")

ggsave("output/preview_deso_gr_2025.png", p2, 
       width = 12, height = 10, dpi = 150)
message("‚úì output/preview_deso_gr_2025.png")

# 3. RegSO G√∂teborg
p3 <- ggplot(regso_goteborg) +
  geom_sf(fill = "#0076bc", color = "white", linewidth = 0.2) +
  labs(
    title = "RegSO 2025 - G√∂teborg",
    subtitle = paste(nrow(regso_goteborg), "RegSO-omr√•den")
  ) +
  theme_void()

ggsave("output/preview_regso_goteborg_2025.png", p3, 
       width = 10, height = 10, dpi = 150)
message("‚úì output/preview_regso_goteborg_2025.png")

message("\n‚úì ALLT KLART!\n")










# Ladda DeSO och statistik
deso_gbg <- load_prepared_map("goteborg/deso_goteborg")
# ‚Üí ~700 DeSO-omr√•den

# Exempel: SCB-statistik p√• DeSO-niv√•

library("pxweb")

url_address <- "https://api.scb.se/OV0104/v1/doris/sv/ssd/START/BO/BO0104/BO0104X/BO0104T01N2"

deso_uppladelseform_scb <- pxweb_get(
  url = url_address,
  query = list(
    Region = c("*"),
    Upplatelseform =  c("*"),
    Tid = "2024",
    ContentsCode = c("*")
  )
)

# Bearbeta data
befolkning_deso <- as.data.frame(deso_uppladelseform_scb) |>
  pivot_wider(names_from = uppl√•telseform, values_from = Antal) |>
  mutate(andel_aganderatt = √§gander√§tt / (hyresr√§tt + bostadsr√§tt + √§gander√§tt)) |> 
  rename(desokod = region)







## 9. DeSO-karta f√∂r G√∂teborg med SCB-data (NYTT!)

Finmaskig karta med DeSO-omr√•den och bostadsdata fr√•n SCB.

```r
library(pxweb)
library(tidyr)

# 1. H√ÑMTA DATA FR√ÖN SCB
url_address <- "https://api.scb.se/OV0104/v1/doris/sv/ssd/START/BO/BO0104/BO0104X/BO0104T01N2"

deso_uppladelseform_scb <- pxweb_get(
  url = url_address,
  query = list(
    Region = c("*"),
    Upplatelseform = c("*"),
    Tid = "2024",
    ContentsCode = c("*")
  )
)

# 2. BEARBETA DATA
bostader_deso <- as.data.frame(deso_uppladelseform_scb) |>
  pivot_wider(names_from = uppl√•telseform, values_from = Antal) |>
  mutate(
    andel_aganderatt = √§gander√§tt / (hyresr√§tt + bostadsr√§tt + √§gander√§tt),
    andel_aganderatt_pct = andel_aganderatt * 100  # Till procent
  ) |>
  rename(desokod = region)

# 3. LADDA DESO OCH KOPPLA DATA
deso_gbg <- load_prepared_map("goteborg/deso_goteborg")
# ‚Üí ~700 DeSO-omr√•den

karta <- join_stat_to_map(deso_gbg, bostader_deso, by = "desokod")
# ‚úì Perfekt matchning: 700/700 omr√•den

# 4. KLASSINDELA
# Anv√§nd fisher f√∂r att hitta naturliga brytpunkter i √§gander√§ttsandel
breaks <- create_breaks(karta$andel_aganderatt_pct, "fisher", 5)
labels <- create_labels(breaks, "range", decimals = 0, unit = "%")
karta$klass <- apply_classification(karta$andel_aganderatt_pct, breaks, labels)

# 5. SKAPA KARTA
ggplot(karta, aes(fill = klass)) +
  geom_sf(color = "white", linewidth = 0.05) +
  geom_sf(data = load_water_layer("goteborg/hav_goteborg"), fill = "lightblue", color = "white") +
  scale_fill_gbg_sequential("green", n = 5) +
  labs(
    title = "Andel sm√•hus (√§gander√§tt) per DeSO-omr√•de",
    subtitle = "G√∂teborg, ~700 DeSO-omr√•den",
    fill = "Andel sm√•hus (%)",
    caption = "K√§lla: SCB (2024)"
  ) +
  theme_gothenburg_map()

# 6. SPARA
ggsave("output/maps/deso_gbg_smahus.png", width = 12, height = 10, dpi = 300)
```

---
  
  ## 10. RegSO-karta f√∂r G√∂teborg (NYTT!)
  
  √ñversiktskarta med RegSO-omr√•den (gr√∂vre indelning). Aggregerar DeSO-data till RegSO-niv√•.

```r
# 1. ANV√ÑND SAMMA BOSTADSDATA FR√ÖN EXEMPEL 9
# (se exempel 9 f√∂r hur data h√§mtas fr√•n SCB)

# 2. LADDA DESO MED REGSO-KOPPLING
deso_gbg <- load_prepared_map("goteborg/deso_goteborg")
# ‚Üí Har redan RegSO_2025 kolumn!

# 3. KOPPLA BOSTADSDATA TILL DESO
deso_med_data <- deso_gbg |>
  left_join(bostader_deso, by = "desokod")

# 4. AGGREGERA DESO TILL REGSO-NIV√Ö
# R√§kna ut totalt antal bost√§der per RegSO och andel sm√•hus
regso_data <- deso_med_data |>
  st_drop_geometry() |>
  group_by(RegSO_2025, RegSOkod_2025) |>
  summarise(
    totalt_hyresratt = sum(hyresr√§tt, na.rm = TRUE),
    totalt_bostadsratt = sum(bostadsr√§tt, na.rm = TRUE),
    totalt_aganderatt = sum(√§gander√§tt, na.rm = TRUE),
    antal_deso = n()
  ) |>
  mutate(
    andel_aganderatt = totalt_aganderatt / 
      (totalt_hyresratt + totalt_bostadsratt + totalt_aganderatt),
    andel_aganderatt_pct = andel_aganderatt * 100
  )

# 5. LADDA REGSO-GEOMETRI OCH KOPPLA
regso_gbg <- load_prepared_map("goteborg/regso_goteborg")
# ‚Üí ~90 RegSO-omr√•den

karta <- regso_gbg |>
  left_join(regso_data, by = c("regsonamn" = "RegSO_2025"))

# 6. KLASSINDELA
breaks <- create_breaks(karta$andel_aganderatt_pct, "fisher", 5)
labels <- create_labels(breaks, "range", decimals = 0, unit = "%")
karta$klass <- apply_classification(karta$andel_aganderatt_pct, breaks, labels)

# 7. SKAPA KARTA
ggplot(karta, aes(fill = klass)) +
  geom_sf(color = "white", linewidth = 0.2) +
  geom_sf(data = load_water_layer("goteborg/hav_goteborg"), fill = "lightblue") +
  scale_fill_gbg_sequential("green", n = 5) +
  labs(
    title = "Andel sm√•hus (√§gander√§tt) per RegSO-omr√•de",
    subtitle = "G√∂teborg, ~90 RegSO-omr√•den (aggregerat fr√•n DeSO)",
    fill = "Andel sm√•hus (%)",
    caption = "K√§lla: SCB (2024)"
  ) +
  theme_gothenburg_map()

# 8. SPARA
ggsave("output/maps/regso_gbg_smahus.png", width = 12, height = 10, dpi = 300)
```

**TIPS:** RegSO √§r gr√∂vre ‚Üí l√§ttare att se √∂vergripande m√∂nster √§n DeSO.

---
  
  ## 11. DeSO G√∂teborgsregionen med kommunf√§rger (NYTT!)
  
  Visa DeSO-omr√•den i G√∂teborgsregionens 13 kommuner med olika f√§rger per kommun och bostadsdata.

```r
# 1. ANV√ÑND SAMMA BOSTADSDATA FR√ÖN EXEMPEL 9
# (se exempel 9 f√∂r hur data h√§mtas fr√•n SCB)

# 2. LADDA DESO F√ñR G√ñTEBORGSREGIONEN
deso_gr <- load_prepared_map("sverige/deso_gr")
# ‚Üí ~2400 DeSO-omr√•den i 13 kommuner

# 3. KOPPLA BOSTADSDATA
karta <- join_stat_to_map(deso_gr, bostader_deso, by = "desokod")

# 4. DEFINIERA F√ÑRGER PER KOMMUN
# G√∂teborg: G√∂teborgsbl√•
# N√§rliggande (H√§rryda, M√∂lndal, Partille, Kung√§lv, Lerum): dark_colors
# √ñvriga 7: light_colors

kommunfarger <- c(
  "1480" = "#0076bc",      # G√∂teborg - G√∂teborgsbl√•
  "1401" = "#084b83",      # H√§rryda - dark_blue
  "1481" = "#6b2c5c",      # M√∂lndal - dark_purple
  "1402" = "#8b5c10",      # Partille - dark_orange
  "1482" = "#005f51",      # Kung√§lv - dark_green
  "1441" = "#a4343a",      # Lerum - dark_red
  "1440" = "#b3d9ff",      # Ale - light_blue
  "1489" = "#d9c3d9",      # Alings√•s - light_purple
  "1384" = "#ffd699",      # Kungsbacka - light_orange
  "1462" = "#a6d9cc",      # Lilla Edet - light_green
  "1415" = "#ffb3b3",      # Stenungsund - light_red
  "1419" = "#c2e0f2",      # Tj√∂rn - light_cyan
  "1407" = "#ffe6cc"       # √ñcker√∂ - light_peach
)

# 5. SKAPA KARTA - KOMMUN√ñVERSIKT
ggplot(karta, aes(fill = kommunkod)) +
  geom_sf(color = "white", linewidth = 0.02) +
  scale_fill_manual(
    values = kommunfarger,
    labels = c(
      "1480" = "G√∂teborg",
      "1401" = "H√§rryda",
      "1481" = "M√∂lndal",
      "1402" = "Partille",
      "1482" = "Kung√§lv",
      "1441" = "Lerum",
      "1440" = "Ale",
      "1489" = "Alings√•s",
      "1384" = "Kungsbacka",
      "1462" = "Lilla Edet",
      "1415" = "Stenungsund",
      "1419" = "Tj√∂rn",
      "1407" = "√ñcker√∂"
    )
  ) +
  labs(
    title = "DeSO-omr√•den i G√∂teborgsregionen",
    subtitle = "~2400 omr√•den i 13 kommuner",
    fill = "Kommun",
    caption = "K√§lla: SCB"
  ) +
  theme_gothenburg_map() +
  theme(legend.position = "right")

# 6. ALTERNATIV: KARTA MED SM√ÖHUSANDEL
# Klassindela andel sm√•hus
breaks <- create_breaks(karta$andel_aganderatt_pct, "fisher", 6)
labels <- create_labels(breaks, "range", decimals = 0, unit = "%")
karta$klass <- apply_classification(karta$andel_aganderatt_pct, breaks, labels)

ggplot(karta, aes(fill = klass)) +
  geom_sf(color = "white", linewidth = 0.02) +
  scale_fill_gbg_sequential("green", n = 6) +
  labs(
    title = "Andel sm√•hus i G√∂teborgsregionen",
    subtitle = "DeSO-omr√•den (~2400), klassificering: Fisher",
    fill = "Andel sm√•hus (%)",
    caption = "K√§lla: SCB (2024)"
  ) +
  theme_gothenburg_map()

# 7. SPARA
ggsave("output/maps/deso_gr_kommuner.png", width = 12, height = 10, dpi = 300)
```

---
  
  ## 12. RegSO G√∂teborgsregionen med kommunf√§rger (NYTT!)
  
  √ñversiktskarta med RegSO-omr√•den i G√∂teborgsregionen (gr√∂vre indelning).

```r
# 1. ANV√ÑND SAMMA BOSTADSDATA FR√ÖN EXEMPEL 9

# 2. LADDA DESO OCH AGGREGERA TILL REGSO
deso_gr <- load_prepared_map("sverige/deso_gr")

# Koppla bostadsdata till DeSO
deso_med_data <- deso_gr |>
  left_join(bostader_deso, by = "desokod")

# Aggregera till RegSO-niv√•
regso_data <- deso_med_data |>
  st_drop_geometry() |>
  group_by(RegSO_2025, RegSOkod_2025, kommunkod, kommunnamn) |>
  summarise(
    totalt_hyresratt = sum(hyresr√§tt, na.rm = TRUE),
    totalt_bostadsratt = sum(bostadsr√§tt, na.rm = TRUE),
    totalt_aganderatt = sum(√§gander√§tt, na.rm = TRUE),
    antal_deso = n()
  ) |>
  mutate(
    andel_aganderatt = totalt_aganderatt / 
      (totalt_hyresratt + totalt_bostadsratt + totalt_aganderatt),
    andel_aganderatt_pct = andel_aganderatt * 100
  )

# 3. LADDA REGSO-GEOMETRI OCH KOPPLA
regso_gr <- load_prepared_map("sverige/regso_gr")
# ‚Üí ~300 RegSO-omr√•den i 13 kommuner

karta <- regso_gr |>
  left_join(regso_data, by = c("regsonamn" = "RegSO_2025"))

# 4. ANV√ÑND SAMMA KOMMUNF√ÑRGER SOM EXEMPEL 11
kommunfarger <- c(
  "1480" = "#0076bc",      # G√∂teborg - G√∂teborgsbl√•
  "1401" = "#084b83",      # H√§rryda - dark_blue
  "1481" = "#6b2c5c",      # M√∂lndal - dark_purple
  "1402" = "#8b5c10",      # Partille - dark_orange
  "1482" = "#005f51",      # Kung√§lv - dark_green
  "1441" = "#a4343a",      # Lerum - dark_red
  "1440" = "#b3d9ff",      # Ale - light_blue
  "1489" = "#d9c3d9",      # Alings√•s - light_purple
  "1384" = "#ffd699",      # Kungsbacka - light_orange
  "1462" = "#a6d9cc",      # Lilla Edet - light_green
  "1415" = "#ffb3b3",      # Stenungsund - light_red
  "1419" = "#c2e0f2",      # Tj√∂rn - light_cyan
  "1407" = "#ffe6cc"       # √ñcker√∂ - light_peach
)

# 5. SKAPA KARTA - KOMMUN√ñVERSIKT
ggplot(karta, aes(fill = kommunkod)) +
  geom_sf(color = "white", linewidth = 0.1) +
  scale_fill_manual(
    values = kommunfarger,
    labels = c(
      "1480" = "G√∂teborg",
      "1401" = "H√§rryda",
      "1481" = "M√∂lndal",
      "1402" = "Partille",
      "1482" = "Kung√§lv",
      "1441" = "Lerum",
      "1440" = "Ale",
      "1489" = "Alings√•s",
      "1384" = "Kungsbacka",
      "1462" = "Lilla Edet",
      "1415" = "Stenungsund",
      "1419" = "Tj√∂rn",
      "1407" = "√ñcker√∂"
    )
  ) +
  labs(
    title = "RegSO-omr√•den i G√∂teborgsregionen",
    subtitle = "~300 omr√•den i 13 kommuner (gr√∂vre indelning √§n DeSO)",
    fill = "Kommun",
    caption = "K√§lla: SCB"
  ) +
  theme_gothenburg_map() +
  theme(
    legend.position = "right",
    legend.key.size = unit(0.5, "cm")
  )

# 6. ALTERNATIV: KARTA MED SM√ÖHUSANDEL
breaks <- create_breaks(karta$andel_aganderatt_pct, "fisher", 6)
labels <- create_labels(breaks, "range", decimals = 0, unit = "%")
karta$klass <- apply_classification(karta$andel_aganderatt_pct, breaks, labels)

ggplot(karta, aes(fill = klass)) +
  geom_sf(color = "white", linewidth = 0.1) +
  scale_fill_gbg_sequential("green", n = 6) +
  labs(
    title = "Andel sm√•hus i G√∂teborgsregionen (RegSO-niv√•)",
    subtitle = "~300 RegSO-omr√•den (aggregerat fr√•n DeSO)",
    fill = "Andel sm√•hus (%)",
    caption = "K√§lla: SCB (2024)"
  ) +
  theme_gothenburg_map()

# 7. SPARA
ggsave("output/maps/regso_gr_kommuner.png", width = 12, height = 10, dpi = 300)


















befolkning_deso <- deso_uppladelseform_scb #read_csv("data/befolkning_deso_2025.csv")
# Kolumner: desokod, befolkning, medelinkomst

# Koppla data
karta <- join_stat_to_map(deso_gbg, befolkning_deso, by = "desokod")

# Klassindela
breaks <- create_breaks(karta$andel_aganderatt, "fisher", 5)
labels <- create_labels(breaks, "range", decimals = 0, unit = "inv√•nare")
karta$klass <- apply_classification(karta$andel_aganderatt, breaks, labels)

# Skapa karta
ggplot(karta, aes(fill = klass)) +
  geom_sf(color = "white", linewidth = 0.05) +
  scale_fill_gbg_sequential("blue", n = 5) +
  labs(
    title = "Befolkning per DeSO-omr√•de - G√∂teborg",
    subtitle = "~700 DeSO-omr√•den",
    fill = "Befolkning",
    caption = "K√§lla: SCB"
  ) +
  theme_gothenburg_map()

10. RegSO-karta f√∂r G√∂teborg (NYTT!)
√ñversiktskarta med RegSO-omr√•den (gr√∂vre indelning).
r# Ladda RegSO
regso_gbg <- load_prepared_map("goteborg/regso_goteborg")
# ‚Üí ~90 RegSO-omr√•den

# Koppla data (samma statistik kan aggregeras till RegSO)
befolkning_regso <- befolkning_deso |>
  left_join(
    deso_gbg |> st_drop_geometry() |> select(desokod, RegSO_2025, RegSOkod_2025),
    by = "desokod"
  ) |>
  group_by(RegSO_2025) |>
  summarise(befolkning = sum(befolkning, na.rm = TRUE))

# Koppla till RegSO-geometri
karta <- regso_gbg |>
  left_join(befolkning_regso, by = c("regsonamn" = "RegSO_2025"))

# Klassindela
breaks <- create_breaks(karta$befolkning, "fisher", 5)
labels <- create_labels(breaks, "range", decimals = 0, unit = "inv√•nare")
karta$klass <- apply_classification(karta$befolkning, breaks, labels)

# Skapa karta
ggplot(karta, aes(fill = klass)) +
  geom_sf(color = "white", linewidth = 0.2) +
  scale_fill_gbg_sequential("blue", n = 5) +
  labs(
    title = "Befolkning per RegSO-omr√•de - G√∂teborg",
    subtitle = "~90 RegSO-omr√•den (gr√∂vre indelning √§n DeSO)",
    fill = "Befolkning",
    caption = "K√§lla: SCB"
  ) +
  theme_gothenburg_map()

11. DeSO G√∂teborgsregionen med kommunf√§rger (NYTT!)
Visa DeSO-omr√•den i G√∂teborgsregionens 13 kommuner med olika f√§rger per kommun.
r# Ladda DeSO f√∂r G√∂teborgsregionen
deso_gr <- load_prepared_map("sverige/deso_gr")
# ‚Üí ~2400 DeSO-omr√•den i 13 kommuner

# Definiera f√§rger per kommun
# G√∂teborg: G√∂teborgsbl√•
# N√§rliggande (H√§rryda, M√∂lndal, Partille, Kung√§lv, Lerum): dark_colors
# √ñvriga 7: light_colors

kommunfarger <- c(
  "1480" = "#0076bc",      # G√∂teborg - G√∂teborgsbl√•
  "1401" = "#084b83",      # H√§rryda - dark_blue
  "1481" = "#6b2c5c",      # M√∂lndal - dark_purple
  "1402" = "#8b5c10",      # Partille - dark_orange
  "1482" = "#005f51",      # Kung√§lv - dark_green
  "1441" = "#a4343a",      # Lerum - dark_red
  "1440" = "#b3d9ff",      # Ale - light_blue
  "1489" = "#d9c3d9",      # Alings√•s - light_purple
  "1384" = "#ffd699",      # Kungsbacka - light_orange
  "1462" = "#a6d9cc",      # Lilla Edet - light_green
  "1415" = "#ffb3b3",      # Stenungsund - light_red
  "1419" = "#c2e0f2",      # Tj√∂rn - light_cyan
  "1407" = "#ffe6cc"       # √ñcker√∂ - light_peach
)

# Skapa karta
ggplot(deso_gr, aes(fill = kommunkod)) +
  geom_sf(color = "white", linewidth = 0.02) +
  scale_fill_manual(
    values = kommunfarger,
    labels = c(
      "1480" = "G√∂teborg",
      "1401" = "H√§rryda",
      "1481" = "M√∂lndal",
      "1402" = "Partille",
      "1482" = "Kung√§lv",
      "1441" = "Lerum",
      "1440" = "Ale",
      "1489" = "Alings√•s",
      "1384" = "Kungsbacka",
      "1462" = "Lilla Edet",
      "1415" = "Stenungsund",
      "1419" = "Tj√∂rn",
      "1407" = "√ñcker√∂"
    )
  ) +
  labs(
    title = "DeSO-omr√•den i G√∂teborgsregionen",
    subtitle = "~2400 omr√•den i 13 kommuner",
    fill = "Kommun",
    caption = "K√§lla: SCB"
  ) +
  theme_gothenburg_map() +
  theme(legend.position = "right")

# Spara
ggsave("output/maps/deso_gr_kommuner.png", width = 12, height = 10, dpi = 300)

12. RegSO G√∂teborgsregionen med kommunf√§rger (NYTT!)
√ñversiktskarta med RegSO-omr√•den i G√∂teborgsregionen.
r# Ladda RegSO f√∂r G√∂teborgsregionen
regso_gr <- load_prepared_map("sverige/regso_gr")
# ‚Üí ~300 RegSO-omr√•den i 13 kommuner

# Anv√§nd samma kommunf√§rger som i exempel 11
kommunfarger <- c(
  "1480" = "#0076bc",      # G√∂teborg - G√∂teborgsbl√•
  "1401" = "#084b83",      # H√§rryda - dark_blue
  "1481" = "#6b2c5c",      # M√∂lndal - dark_purple
  "1402" = "#8b5c10",      # Partille - dark_orange
  "1482" = "#005f51",      # Kung√§lv - dark_green
  "1441" = "#a4343a",      # Lerum - dark_red
  "1440" = "#b3d9ff",      # Ale - light_blue
  "1489" = "#d9c3d9",      # Alings√•s - light_purple
  "1384" = "#ffd699",      # Kungsbacka - light_orange
  "1462" = "#a6d9cc",      # Lilla Edet - light_green
  "1415" = "#ffb3b3",      # Stenungsund - light_red
  "1419" = "#c2e0f2",      # Tj√∂rn - light_cyan
  "1407" = "#ffe6cc"       # √ñcker√∂ - light_peach
)

# Skapa karta
ggplot(regso_gr, aes(fill = kommunkod)) +
  geom_sf(color = "white", linewidth = 0.1) +
  scale_fill_manual(
    values = kommunfarger,
    labels = c(
      "1480" = "G√∂teborg",
      "1401" = "H√§rryda",
      "1481" = "M√∂lndal",
      "1402" = "Partille",
      "1482" = "Kung√§lv",
      "1441" = "Lerum",
      "1440" = "Ale",
      "1489" = "Alings√•s",
      "1384" = "Kungsbacka",
      "1462" = "Lilla Edet",
      "1415" = "Stenungsund",
      "1419" = "Tj√∂rn",
      "1407" = "√ñcker√∂"
    )
  ) +
  labs(
    title = "RegSO-omr√•den i G√∂teborgsregionen",
    subtitle = "~300 omr√•den i 13 kommuner (gr√∂vre indelning √§n DeSO)",
    fill = "Kommun",
    caption = "K√§lla: SCB"
  ) +
  theme_gothenburg_map() +
  theme(
    legend.position = "right",
    legend.key.size = unit(0.5, "cm")
  )

# Spara
ggsave("output/maps/regso_gr_kommuner.png", width = 12, height = 10, dpi = 300)







library(sf)

# 1. Ber√§kna centroider f√∂r varje kommun (d√§r etiketten ska placeras)
kommuner_centroids <- kommuner_gr |>
  group_by(kommun_kod, kommun_namn) |>
  summarise(geometry = st_union(geometry)) |>
  st_centroid()

# 2. Skapa karta MED etiketter
ggplot() +
  # DeSO-omr√•den f√§rgade per kommun
  geom_sf(data = deso_gr, aes(fill = kommunkod), 
          color = "white", linewidth = 0.02) +
  
  # Kommunnamn som etiketter
  geom_sf_text(data = kommuner_centroids, 
               aes(label = kommun_namn),
               size = 3.5,
               fontface = "bold",
               color = "black") +
  
  # F√§rgschema
  scale_fill_manual(
    values = kommunfarger,
    guide = "none"  # TA BORT legend
  ) +
  
  # Titlar
  labs(
    title = "DeSO-omr√•den i G√∂teborgsregionen",
    subtitle = "~2400 omr√•den i 13 kommuner",
    caption = "K√§lla: SCB"
  ) +
  
  theme_gothenburg_map()







library(ggrepel)  # install.packages("ggrepel") om du inte har det

ggplot() +
  # DeSO-omr√•den
  geom_sf(data = deso_gr, aes(fill = kommunkod), 
          color = "white", linewidth = 0.02) +
  
  # Etiketter med VIT BAKGRUND
  geom_label_repel(
    data = kommuner_centroids,
    aes(label = kommun_namn, 
        geometry = geometry),
    stat = "sf_coordinates",
    size = 3.5,
    fontface = "bold",
    color = "black",
    fill = "white",           # Vit bakgrund
    label.padding = 0.25,     # Padding runt text
    label.size = 0.3,         # Ram runt label
    alpha = 0.9,              # Lite genomskinlig
    segment.color = "gray30", # Linjef√§rg om text flyttas
    min.segment.length = 0
  ) +
  
  scale_fill_manual(values = kommunfarger, guide = "none") +
  
  labs(
    title = "DeSO-omr√•den i G√∂teborgsregionen",
    subtitle = "",
    caption = "K√§lla: SCB"
  ) +
  
  theme_gothenburg_map()
