# üìñ Geodata - Ladda och hantera kartlager

Funktioner f√∂r att ladda f√∂rberedda kartlager, DeSO/RegSO fr√•n SCB och koppla statistik.

---

## Inneh√•llsf√∂rteckning

### F√∂rberedda kartlager
1. [load_prepared_map()](#load_prepared_map) - Ladda kartlager
2. [load_water_layer()](#load_water_layer) - Ladda vattenlager
3. [list_prepared_maps()](#list_prepared_maps) - Lista tillg√§ngliga kartlager

### DeSO och RegSO (SCB 2025)
4. [load_deso_from_scb()](#load_deso_from_scb) - Ladda DeSO 2025
5. [load_regso_from_scb()](#load_regso_from_scb) - Ladda RegSO 2025
6. [load_deso_regso_koppling()](#load_deso_regso_koppling) - Ladda kopplingstabell

### Generell geodata
7. [load_geo_layer()](#load_geo_layer) - Ladda egna shapefiles/GeoJSON

### Statistik och spatial analys
8. [join_stat_to_map()](#join_stat_to_map) - Koppla statistik till karta
9. [join_points_to_areas()](#join_points_to_areas) - Koppla punkter till omr√•den

---

## load_prepared_map() {#load_prepared_map}

### Beskrivning

L√§ser in ett f√∂rberett kartlager i rds-format. Snabbare √§n att l√§sa shapefiler varje g√•ng.

### Syntax

```r
load_prepared_map(map_name, data_dir = "input/prepared_maps")
```

### Parametrar

- **map_name** (character): Namn p√• kartlagret med mapp (utan .rds-suffix)
  - Format: `"mapp/filnamn"`
  - Exempel: `"goteborg/primaromraden"`, `"sverige/kommuner"`
- **data_dir** (character): Mapp d√§r f√∂rberedda kartlager finns (default: `"input/prepared_maps"`)

### Returnerar

sf-objekt med kartgeometrier

### Tillg√§ngliga kartlager

#### G√∂teborg
- `"goteborg/primaromraden"` - Prim√§romr√•den
- `"goteborg/stadsdelar"` - Stadsdelar
- `"goteborg/basomraden"` - Basomr√•den
- `"goteborg/kommungrans"` - Kommungr√§ns
- `"goteborg/deso_goteborg"` - **DeSO 2025 f√∂r G√∂teborg** (med RegSO-info)
- `"goteborg/regso_goteborg"` - **RegSO 2025 f√∂r G√∂teborg**

#### Sverige
- `"sverige/kommuner"` - Sveriges kommuner
- `"sverige/lan"` - Sveriges l√§n
- `"sverige/regioner"` - Sveriges regioner
- `"sverige/deso_gr"` - **DeSO 2025 f√∂r G√∂teborgsregionen** (med RegSO-info)
- `"sverige/regso_gr"` - **RegSO 2025 f√∂r G√∂teborgsregionen**

### Exempel

```r
# G√∂teborg - traditionella lager
primaromraden <- load_prepared_map("goteborg/primaromraden")
stadsdelar <- load_prepared_map("goteborg/stadsdelar")

# G√∂teborg - DeSO/RegSO
deso_gbg <- load_prepared_map("goteborg/deso_goteborg")
# ‚Üí ~700 DeSO-omr√•den med RegSO-info

regso_gbg <- load_prepared_map("goteborg/regso_goteborg")
# ‚Üí ~90 RegSO-omr√•den

# Sverige
kommuner <- load_prepared_map("sverige/kommuner")
deso_gr <- load_prepared_map("sverige/deso_gr")
# ‚Üí ~2400 DeSO-omr√•den i G√∂teborgsregionens 13 kommuner

# Enkel preview
plot(st_geometry(deso_gbg))
```

### DeSO-kolumner

N√§r du laddar DeSO-lager f√•r du f√∂ljande kolumner:

```r
deso_gbg <- load_prepared_map("goteborg/deso_goteborg")
names(deso_gbg)
# ‚Üí "desokod", "regsokod", "kommunkod", "kommunnamn",
#   "RegSO_2025", "RegSOkod_2025", "geometry"
```

- **desokod**: DeSO-omr√•dets kod (t.ex. "1480C1010")
- **regsokod**: RegSO-kod fr√•n SCB
- **kommunkod**: Kommunkod (t.ex. "1480" f√∂r G√∂teborg)
- **kommunnamn**: Kommunnamn
- **RegSO_2025**: RegSO-omr√•dets namn (fr√•n kopplingstabell)
- **RegSOkod_2025**: RegSO-kod (fr√•n kopplingstabell)
- **geometry**: Geometri

### Best Practices

```r
# Spara ofta anv√§nda lager i variabler
goteborg_primaromraden <- load_prepared_map("goteborg/primaromraden")
goteborg_deso <- load_prepared_map("goteborg/deso_goteborg")

# Filtrera DeSO till specifikt omr√•de
deso_centrum <- goteborg_deso |>
  filter(str_detect(RegSO_2025, "Centrum"))

# Aggregera DeSO till RegSO-niv√•
regso_aggregerad <- goteborg_deso |>
  st_drop_geometry() |>
  group_by(RegSO_2025, RegSOkod_2025) |>
  summarise(antal_deso = n())
```

---

## load_water_layer() {#load_water_layer}

### Beskrivning

L√§ser in f√∂rberedda vattenlager (√§lvar, sj√∂ar, hav) f√∂r visualisering.

### Syntax

```r
load_water_layer(water_name, data_dir = "input/prepared_maps")
```

### Parametrar

- **water_name** (character): Namn p√• vattenlagret med mapp (utan .rds-suffix)
- **data_dir** (character): Mapp d√§r f√∂rberedda vattenlager finns

### Returnerar

sf-objekt med vattengeometrier, eller NULL om fil saknas

### Exempel

```r
# Ladda √§lv och hav
alv <- load_water_layer("goteborg/alv_goteborg")
hav <- load_water_layer("goteborg/hav_goteborg")

# Kombinera med DeSO-karta
deso_gbg <- load_prepared_map("goteborg/deso_goteborg")

ggplot() +
  geom_sf(data = deso_gbg, fill = "lightgray") +
  geom_sf(data = alv, fill = "#b3d9ff", color = NA) +
  theme_void()
```

---

## list_prepared_maps() {#list_prepared_maps}

### Beskrivning

Visar information om alla f√∂rberedda kartlager i en tabell.

### Syntax

```r
list_prepared_maps(data_dir = "input/prepared_maps", pattern = "\\.rds$")
```

### Returnerar

Data.frame med information om tillg√§ngliga kartlager

### Exempel

```r
# Lista alla
kartlager <- list_prepared_maps()
View(kartlager)

# Filtrera till DeSO/RegSO
kartlager |> filter(str_detect(map_name, "deso|regso"))
```

---

## load_deso_from_scb() {#load_deso_from_scb}

### Beskrivning

H√§mtar Demografiska statistikomr√•den (DeSO 2025) direkt fr√•n SCB:s WFS-tj√§nst.

**DeSO** √§r SCB:s standardindelning f√∂r statistikredovisning p√• lokal niv√•. Omr√•dena √§r relativt likv√§rdiga vad g√§ller befolkningsstorlek (~1000-2000 inv√•nare).

**DeSO 2025** √§r den nya versionen som g√§ller fr√•n 2025-01-01. All statistik som SCB publicerar under 2025 anv√§nder denna indelning.

### Syntax

```r
load_deso_from_scb(crs = 3006, simplify = FALSE, tolerance = 100)
```

### Parametrar

- **crs** (numeric): M√•lprojektion (default: 3006 = SWEREF99 TM)
- **simplify** (logical): F√∂renkla geometri f√∂r snabbare rendering? (default: FALSE)
- **tolerance** (numeric): Tolerans f√∂r simplify i meter (default: 100)

### Returnerar

sf-objekt med ~5900 DeSO 2025-omr√•den f√∂r hela Sverige

### Kolumner

- **desokod**: DeSO-kod (8 tecken, t.ex. "1480C1010")
- **regsokod**: RegSO-kod
- **kommunkod**: Kommunkod (4 tecken)
- **kommunnamn**: Kommunnamn
- **lanskod**: L√§nskod
- **geometry**: Polygongeometri

### Exempel

```r
# Ladda alla DeSO f√∂r Sverige
deso_alla <- load_deso_from_scb()
# ‚Üí ~5900 omr√•den

# Filtrera till G√∂teborg
deso_gbg <- deso_alla |>
  filter(kommunkod == "1480")
# ‚Üí ~700 omr√•den

# Filtrera till G√∂teborgsregionen (13 kommuner)
gr_kommuner <- c("1440", "1489", "1480", "1401", "1384", 
                 "1482", "1441", "1462", "1481", "1402", 
                 "1415", "1419", "1407")

deso_gr <- deso_alla |>
  filter(kommunkod %in% gr_kommuner)
# ‚Üí ~2400 omr√•den

# Med f√∂renkling (snabbare rendering)
deso_enkel <- load_deso_from_scb(simplify = TRUE, tolerance = 100)
```

### N√§r anv√§nda DeSO?

**F√∂rdelar:**
- **Finmaskigt**: Detaljerad geografisk uppl√∂sning (~1000-2000 inv/omr√•de)
- **J√§mf√∂rbart**: Likv√§rdiga omr√•den √∂ver hela Sverige
- **Standardiserat**: SCB:s officiella redovisningsniv√•
- **Tidsserie**: Samma indelning √∂ver tid (inom varje version)

**Anv√§nd DeSO f√∂r:**
- Detaljerade lokala analyser
- Demografisk statistik (befolkning, √•lder, inkomst)
- J√§mf√∂relser mellan omr√•den
- N√§r SCB-statistik ska visualiseras

**Anv√§nd RegSO ist√§llet f√∂r:**
- √ñversiktskartor (gr√∂vre indelning)
- N√§r DeSO blir f√∂r detaljerat
- Mindre dataset som inte beh√∂ver finmaskighet

### VIKTIGT om versioner

**DeSO 2025 vs DeSO 2018:**
- **Statistik 2025‚Üí**: Anv√§nd DeSO 2025
- **Statistik f√∂re 2025**: Anv√§nd DeSO 2018 (separat funktion)
- **J√§mf√∂r inte** mellan versionerna - olika omr√•den!

```r
# R√§tt: Statistik fr√•n 2025
befolkning_2025 <- read_csv("befolkning_2025.csv")  # P√• DeSO 2025
deso_2025 <- load_deso_from_scb()
karta <- join_stat_to_map(deso_2025, befolkning_2025, by = "desokod")

# Fel: Statistik fr√•n 2024 p√• DeSO 2025
befolkning_2024 <- read_csv("befolkning_2024.csv")  # P√• DeSO 2018!
deso_2025 <- load_deso_from_scb()  # Kommer inte matcha!
```

---

## load_regso_from_scb() {#load_regso_from_scb}

### Beskrivning

H√§mtar Regionala statistikomr√•den (RegSO 2025) direkt fr√•n SCB:s WFS-tj√§nst.

**RegSO** √§r en gr√∂vre indelning √§n DeSO (~5000-6000 inv√•nare per omr√•de). Anv√§nd RegSO n√§r DeSO blir f√∂r detaljerat.

### Syntax

```r
load_regso_from_scb(crs = 3006, simplify = FALSE, tolerance = 100)
```

### Parametrar

Samma som `load_deso_from_scb()`

### Returnerar

sf-objekt med ~1300 RegSO 2025-omr√•den f√∂r hela Sverige

### Exempel

```r
# Ladda alla RegSO
regso_alla <- load_regso_from_scb()
# ‚Üí ~1300 omr√•den

# Filtrera till G√∂teborg
regso_gbg <- regso_alla |>
  filter(kommunkod == "1480")
# ‚Üí ~90 omr√•den

# J√§mf√∂r DeSO vs RegSO
deso_gbg <- load_deso_from_scb() |> filter(kommunkod == "1480")
regso_gbg <- load_regso_from_scb() |> filter(kommunkod == "1480")

nrow(deso_gbg)   # ~700 DeSO
nrow(regso_gbg)  # ~90 RegSO
```

### DeSO vs RegSO - N√§r anv√§nda vad?

| Aspekt | DeSO | RegSO |
|--------|------|-------|
| **Antal omr√•den (G√∂teborg)** | ~700 | ~90 |
| **Inv√•nare per omr√•de** | ~1000-2000 | ~5000-6000 |
| **Anv√§ndning** | Detaljerade analyser | √ñversiktskartor |
| **Visualisering** | Mer detaljer, l√•ngsammare | F√§rre detaljer, snabbare |
| **Statistik** | Finmaskig data | Aggregerad data |

**Tumregel:**
- **A4-karta av G√∂teborg**: Anv√§nd RegSO (90 omr√•den)
- **Digital zoombar karta**: Anv√§nd DeSO (700 omr√•den)
- **Sverigekarta**: Anv√§nd RegSO (~1300 omr√•den)

---

## load_deso_regso_koppling() {#load_deso_regso_koppling}

### Beskrivning

H√§mtar kopplingstabellen mellan DeSO 2025 och RegSO 2025 fr√•n SCB. Anv√§nds f√∂r att koppla RegSO-information till DeSO-omr√•den.

### Syntax

```r
load_deso_regso_koppling()
```

### Returnerar

Data.frame med ~5900 rader (en per DeSO) och kolumnerna:
- **Kommun**: Kommunkod
- **Kommunnamn**: Kommunnamn
- **DeSO_2025**: DeSO-kod
- **RegSO_2025**: RegSO-namn
- **RegSOkod_2025**: RegSO-kod

### Exempel

```r
# Ladda kopplingstabell
koppling <- load_deso_regso_koppling()

# Ladda DeSO
deso <- load_deso_from_scb() |> filter(kommunkod == "1480")

# Koppla RegSO-namn till DeSO
deso_med_regso <- deso |>
  left_join(koppling, by = c("desokod" = "DeSO_2025"))

# Nu kan vi f√§rgl√§gga DeSO efter RegSO
ggplot(deso_med_regso, aes(fill = RegSO_2025)) +
  geom_sf() +
  labs(title = "DeSO-omr√•den f√§rgade efter RegSO")
```

### OBS: F√∂rberedda lager har redan koppling!

```r
# Beh√∂ver INTE ladda kopplingstabell manuellt:
deso_gbg <- load_prepared_map("goteborg/deso_goteborg")
# ‚Üí Har redan RegSO_2025 och RegSOkod_2025 kolumner!

names(deso_gbg)
# ‚Üí "desokod", "regsokod", "kommunkod", "kommunnamn",
#   "RegSO_2025", "RegSOkod_2025", "geometry"
```

Anv√§nd bara `load_deso_regso_koppling()` om du laddar DeSO direkt fr√•n SCB med `load_deso_from_scb()`.

---

## load_geo_layer() {#load_geo_layer}

### Beskrivning

Generell funktion f√∂r att ladda geodata fr√•n olika format (Shapefile, GeoJSON, GeoPackage, KML). Anv√§nd n√§r du har egna geografiska filer.

### Syntax

```r
load_geo_layer(
  path,
  layer = NULL,
  crs = 3006,
  simplify = FALSE,
  tolerance = 100,
  clip = NULL,
  validate = TRUE
)
```

### Parametrar

- **path** (character): S√∂kv√§g till fil (.shp, .geojson, .gpkg, .kml)
- **layer** (character): Layer-namn (endast f√∂r GeoPackage med flera lager)
- **crs** (numeric): M√•lprojektion (default: 3006 = SWEREF99 TM)
- **simplify** (logical): F√∂renkla geometri? (default: FALSE)
- **tolerance** (numeric): Tolerans f√∂r simplify i meter (default: 100)
- **clip** (sf): sf-objekt att klippa till (t.ex. kommungr√§ns)
- **validate** (logical): Validera geometri? (default: TRUE)

### Returnerar

sf-objekt i angiven projektion

### Exempel

```r
# Grundl√§ggande - ladda shapefile
byggnader <- load_geo_layer("data/byggnader.shp")

# Ladda GeoJSON
parker <- load_geo_layer("data/parker.geojson")

# Ladda GeoPackage (specifikt lager)
vatten <- load_geo_layer("data/geodata.gpkg", layer = "vatten")

# Med f√∂renkling (snabbare rendering)
kommuner <- load_geo_layer(
  "data/kommuner.shp",
  simplify = TRUE,
  tolerance = 100
)

# Klipp till kommungr√§ns
goteborg_grans <- load_prepared_map("goteborg/kommungrans")
detaljer <- load_geo_layer(
  "data/detaljer.shp",
  clip = goteborg_grans
)

# Annan projektion (t.ex. WGS84 f√∂r webbkartor)
world <- load_geo_layer("data/world.geojson", crs = 4326)
```

### St√∂dda format

- **.shp** - Shapefile (klassiskt GIS-format)
- **.geojson** - GeoJSON (webbanv√§nt, l√§tt att dela)
- **.gpkg** - GeoPackage (modernare √§n Shapefile)
- **.kml** - KML (fr√•n Google Earth)

### Best Practices

```r
# 1. Alltid kontrollera CRS
data <- load_geo_layer("data/myfile.shp")
st_crs(data)  # Kontrollera projektion

# 2. F√∂renkla stora filer
# G√∂r rendering mycket snabbare
data <- load_geo_layer("data/detaljerad.shp", simplify = TRUE)

# 3. Klipp till relevant omr√•de
goteborg <- load_prepared_map("goteborg/kommungrans")
data <- load_geo_layer("data/sverige.shp", clip = goteborg)
```

---

## join_stat_to_map() {#join_stat_to_map}

### Beskrivning

Kopplar tabelldatak√§llor (CSV, Excel, dataframe) till kartgeometrier. S√§kerst√§ller matchning mellan data och geografi.

### Syntax

```r
join_stat_to_map(
  map_data,
  stat_data,
  by = NULL,
  by_map = NULL,
  by_stat = NULL
)
```

### Parametrar

- **map_data** (sf): sf-objekt med kartgeometrier
- **stat_data** (data.frame): Statistikdata
- **by** (character): Kolumnnamn att matcha p√• (om samma i b√•da)
- **by_map** (character): Kolumnnamn i map_data (om olika)
- **by_stat** (character): Kolumnnamn i stat_data (om olika)

### Returnerar

sf-objekt med b√•de geometri och statistik

### Exempel

#### Enkel matchning (samma kolumnnamn)

```r
# Ladda data
deso_gbg <- load_prepared_map("goteborg/deso_goteborg")
befolkning <- read_csv("data/befolkning_deso.csv")

# Koppla
karta <- join_stat_to_map(
  map_data = deso_gbg,
  stat_data = befolkning,
  by = "desokod"
)

# Nu har karta b√•de geometri och statistik
names(karta)
# ‚Üí "desokod", "kommunnamn", "befolkning", "inkomst", "geometry"
```

#### Olika kolumnnamn

```r
# Kommundata med olika kolumnnamn
kommuner <- load_prepared_map("sverige/kommuner")
scb_data <- read_csv("data/scb_befolkning.csv")

karta <- join_stat_to_map(
  map_data = kommuner,
  stat_data = scb_data,
  by_map = "kommun_kod",  # Kolumn i kommuner
  by_stat = "kod"          # Kolumn i scb_data
)
```

#### DeSO-exempel

```r
# Ladda DeSO
deso_gr <- load_prepared_map("sverige/deso_gr")

# SCB-statistik p√• DeSO-niv√•
scb_inkomst <- read_csv("data/inkomst_deso_2025.csv")
# Kolumner: desokod, medelinkomst, medianinkomst

# Koppla
karta <- join_stat_to_map(deso_gr, scb_inkomst, by = "desokod")

# Visualisera
ggplot(karta, aes(fill = medelinkomst)) +
  geom_sf(color = "white", linewidth = 0.05) +
  scale_fill_gbg_sequential("blue")
```

### Matchningsstatus

Funktionen visar automatiskt matchningsstatus:

```r
karta <- join_stat_to_map(deso_gbg, befolkning, by = "desokod")
# Matchar p√• kolumn: 'desokod' = 'desokod'
#   Formaterade matchningskolumner till text
# ‚úì Perfekt matchning: 700/700 omr√•den (100%)
#   ‚úì 700 omr√•den efter merge
```

### Best Practices

```r
# 1. Kontrollera kolumnnamn f√∂rst
names(deso_gbg)
names(befolkning)

# 2. Inspektera matchning
karta <- join_stat_to_map(deso_gbg, befolkning, by = "desokod")
sum(is.na(karta$befolkning))  # Ska vara 0

# 3. Hantera d√•lig matchning
# Problem: olika formattering
befolkning <- befolkning |>
  mutate(desokod = str_pad(desokod, width = 8, pad = "0"))
```

---

## join_points_to_areas() {#join_points_to_areas}

### Beskrivning

Spatial join - kopplar punkter (t.ex. skolor, aff√§rer, h√•llplatser) till polygon-omr√•den och r√§knar antal per omr√•de.

### Syntax

```r
join_points_to_areas(polygons, points, count_column = "n_points")
```

### Parametrar

- **polygons** (sf): sf-objekt med omr√•den (polygon)
- **points** (sf): sf-objekt med punkter
- **count_column** (character): Namn p√• ny kolumn f√∂r antal (default: "n_points")

### Returnerar

sf-objekt (polygons) med ny kolumn f√∂r antal punkter

### Exempel

```r
# R√§kna skolor per DeSO-omr√•de
deso_gbg <- load_prepared_map("goteborg/deso_goteborg")
skolor <- st_read("data/skolor.shp")

deso_skolor <- join_points_to_areas(
  polygons = deso_gbg,
  points = skolor,
  count_column = "antal_skolor"
)

# Visualisera
ggplot(deso_skolor, aes(fill = antal_skolor)) +
  geom_sf(color = "white", linewidth = 0.05) +
  scale_fill_gbg_sequential("green") +
  labs(title = "Antal skolor per DeSO-omr√•de")

# R√§kna h√•llplatser per RegSO
regso_gbg <- load_prepared_map("goteborg/regso_goteborg")
hallplatser <- st_read("data/hallplatser.shp")

regso_hallplatser <- join_points_to_areas(
  regso_gbg,
  hallplatser,
  "antal_hallplatser"
)
```

### Anv√§ndningsomr√•den

- Skolor per omr√•de
- Aff√§rer per stadsdel
- H√•llplatser per DeSO
- Brott per omr√•de
- Restauranger per omr√•de

---

## Snabbreferens

### F√∂rberedda lager

```r
# G√∂teborg
load_prepared_map("goteborg/primaromraden")
load_prepared_map("goteborg/stadsdelar")
load_prepared_map("goteborg/deso_goteborg")    # DeSO 2025
load_prepared_map("goteborg/regso_goteborg")   # RegSO 2025

# Sverige/GR
load_prepared_map("sverige/kommuner")
load_prepared_map("sverige/deso_gr")           # DeSO 2025 GR
load_prepared_map("sverige/regso_gr")          # RegSO 2025 GR
```

### DeSO/RegSO fr√•n SCB

```r
# Ladda direkt fr√•n SCB (f√∂r uppdateringar)
deso <- load_deso_from_scb()
regso <- load_regso_from_scb()
koppling <- load_deso_regso_koppling()

# Filtrera
deso_gbg <- deso |> filter(kommunkod == "1480")
```

### Koppla data

```r
# Samma kolumnnamn
karta <- join_stat_to_map(map, data, by = "kod")

# Olika kolumnnamn
karta <- join_stat_to_map(map, data, by_map = "omrade", by_stat = "kod")

# R√§kna punkter
karta <- join_points_to_areas(omraden, punkter, "antal")
```

---

**Version:** 2.0  
**Uppdaterad:** 2025-12-16  
**Nytt:** DeSO 2025, RegSO 2025, load_geo_layer()